# Example Holmes health checks configuration
# Place this file at ~/.holmes/checks.yaml or specify with --checks-file

version: 1

# Default settings for all checks
defaults:
  timeout: 30  # seconds - max time for each check to complete
  # Note: 'mode' should be set via CLI flag (--mode alert/monitor) not in defaults
  # Individual checks can still override with their own mode setting

# Global destinations for alerts (can be overridden per check)
destinations:
  slack:
    webhook_url: ${SLACK_WEBHOOK_URL}
    channel: "#alerts"
  pagerduty:
    integration_key: ${PAGERDUTY_INTEGRATION_KEY}

checks:
  - name: "Frontend Deployment Health"
    description: "Check if frontend deployment has ready replicas"
    tags: ["kubernetes", "critical", "deployment"]
    query: "Is the deployment 'frontend' in namespace 'production' healthy with at least 2 ready replicas?"
    destinations: ["slack", "pagerduty"]

#  - name: "Certificate Expiry"
#    description: "Check TLS certificates expiration"
#    tags: ["kubernetes", "security", "medium"]
#    query: "Are there any TLS certificates in the cluster expiring within the next 30 days?"
#    schedule: "0 9 * * MON"  # Optional: Only run on Mondays at 9am (future feature)

#  - name: "Disk Space"
#    description: "Check persistent volume usage"
#    tags: ["kubernetes", "storage", "high"]
#    query: "Are any persistent volumes in the cluster above 85% capacity?"
#    repeat: 1  # Check only once

#  - name: "Log Errors Rate"
#    description: "Check for excessive error logs"
#    tags: ["loki", "observability", "medium"]
#    query: "Has the error log rate for holmes pod exceeded 100 errors per minute in the last 10 minutes?"

  - name: "Memory Usage"
    description: "Check if any robusta-runner pod is using more than 90% of its memory limit"
    tags: ["kubernetes", "performance", "warning"]
    query: "Is any pod with name containing 'robusta-runner' using more than 90% of its memory limit?"

  - name: "Nodes Health"
    description: "Verify all nodes are ready"
    tags: ["kubernetes", "infrastructure", "gke"]
    query: "Are all nodes in the cluster in Ready status?"

  - name: "Bookstore Service Available"
    description: "Check if bookstore service is running"
    tags: ["kubernetes", "services", "critical"]
    query: "Is the service 'bookstore-backend' available in the default namespace and are all backing pods healthy?"

  - name: "Datadog Agent Restarts"
    description: "Check if datadog agent has excessive restarts"
    tags: ["monitoring", "datadog", "critical"]
    query: "Does the datadog pod in the default namespace have fewer than 100 container restarts across all its containers?"

  - name: "High Memory Node"
    description: "Check if any node is using excessive memory"
    tags: ["kubernetes", "resources", "performance"]
    query: "Are all nodes in the cluster using less than 85% of their memory capacity?"

  - name: "Backend API Checker Health"
    description: "Check Java API checker pod health"
    tags: ["application", "java", "critical"]
    query: "Are 'java-api-checker' in the default namespace healthy?"

# Usage Examples:
# holmes check                           # Run all checks from this file
# holmes check --mode monitor            # Run all checks in monitor mode (no alerts)
# holmes check --tags critical           # Run only critical checks
# holmes check --name "Pod Health"       # Run specific check by name
# holmes check --parallel                # Run checks in parallel for faster execution
# holmes check --watch --interval 300    # Run checks every 5 minutes

# For inline checks without a config file:
# holmes check -c "Are all pods running?" --mode monitor
# holmes check -c "Is disk usage below 80%?" --mode alert \
#   --slack-webhook "https://hooks.slack.com/..." --slack-channel "#alerts"

# Tips for writing good check queries:
# - Phrase checks so PASS means healthy (e.g., "Are all pods running?")
# - Avoid negative phrasing (e.g., NOT "Is CPU usage above 90%?")
# - Be specific about what constitutes healthy vs unhealthy

# Future feature: Groups for organizing related checks
# check_groups:
#   critical_infrastructure:
#     - "Frontend Deployment Health"
#     - "Database Connection"
#     - "Service Availability"
#   monitoring:
#     - "CPU Usage Check"
#     - "Disk Space"
#     - "Log Errors Rate"
