user_prompt:
- "The checkout service in namespace app-114 is experiencing high latency. Investigate all traces over 1s in duration"

expected_output:
  - The checkout service has intermittent high latency affecting approximately 30% of requests
  - Root cause is missing database index on the shipping_rates table in Postgres
  - Slow queries occur when promo_code parameter is included in the request

tags:
  - kubernetes
  - medium
  - traces

port_forwards:
  - namespace: app-114
    service: tempo
    local_port: 3200
    remote_port: 3200

before_test: |
  echo "üöÄ Setting up test 114 - Creating namespace app-114"
  kubectl create namespace app-114 || true
  echo "‚úÖ Namespace app-114 created successfully!"

  echo "üì¶ Deploying Tempo from shared config"
  kubectl apply -f ../../shared/tempo.yaml -n app-114

  echo "‚è≥ Waiting for Tempo pod to be ready"
  kubectl wait --for=condition=ready pod -l app=tempo -n app-114 --timeout=60s

  echo "üîç Checking Tempo deployment status"
  kubectl get pods -n app-114 -l app=tempo

  echo "‚è∞ Waiting for Tempo to be fully ready (checking every 5s, timeout 60s)"
  TEMPO_READY=false
  for i in {1..12}; do
    if kubectl exec -n app-114 deployment/tempo -- wget -q -O - http://localhost:3200/ready 2>/dev/null; then
      echo "‚úÖ Tempo is ready!"
      TEMPO_READY=true
      break
    else
      echo "‚è≥ Attempt $i/12: Tempo not ready yet, waiting 5s..."
      sleep 5
    fi
  done

  if [ "$TEMPO_READY" = false ]; then
    echo "‚ùå Tempo failed to become ready after 60 seconds"
    exit 1
  fi

  echo "‚úÖ Tempo deployment complete!"

after_test: |
  kubectl delete namespace app-114 || true
