user_prompt: "My pod memory-hog is using a lot of memory. Can you identify which process is consuming the most resources?"
expected_output:
  - The result identifies that the java process is consuming the most memory
  - The result mentions the memory usage is around 4.5GB or 4500MB
  - The result identifies the PID of the high-memory process
  - The result mentions that the container has a memory limit of 6GB
tags:
  - kubernetes

before_test: |
  kubectl create namespace app-144

  # First encode the startup script
  cat > /tmp/startup-144.sh <<'SCRIPT'
  #!/bin/bash
  echo 'public class DataProcessor {
    public static void main(String[] args) throws Exception {
      // Initialize data buffer for processing
      long bufferSize = 4500L * 1024 * 1024;
      byte[] dataBuffer = new byte[(int)bufferSize];
      System.out.println("Data processor initialized with buffer size: " + bufferSize + " bytes");

      // Keep the processor running
      while (true) {
        Thread.sleep(10000);
      }
    }
  }' > DataProcessor.java
  javac DataProcessor.java
  java -Xmx5g DataProcessor
  SCRIPT

  # Create secret with the startup script
  kubectl create secret generic app-code \
    --from-file=startup.sh=/tmp/startup-144.sh \
    -n app-144

  rm /tmp/startup-144.sh

  # Create deployment using the secret
  cat <<EOF | kubectl apply -f -
  apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: memory-hog
    namespace: app-144
  spec:
    replicas: 1
    selector:
      matchLabels:
        app: memory-hog
    template:
      metadata:
        labels:
          app: memory-hog
      spec:
        containers:
        - name: java-app
          image: openjdk:11-jre-slim
          command: ["/bin/bash", "/app/startup.sh"]
          volumeMounts:
          - name: app-code
            mountPath: /app
          resources:
            limits:
              memory: "6Gi"
            requests:
              memory: "6Gi"
        volumes:
        - name: app-code
          secret:
            secretName: app-code
            defaultMode: 0755
  EOF
  sleep 30

after_test: |
  kubectl delete namespace app-144 --force --grace-period=0
