apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: auth-service
  template:
    metadata:
      labels:
        app: auth-service
    spec:
      containers:
      - name: auth-service
        image: busybox
        command:
        - sh
        - -c
        - |
          # Generate timestamps for 48 hours ago
          FORTY_EIGHT_HOURS_AGO=$(date -u -d '48 hours ago' '+%Y-%m-%dT%H:%M:%S.%3NZ' 2>/dev/null || date -u -v-48H '+%Y-%m-%dT%H:%M:%S.%3NZ')
          FORTY_EIGHT_HOURS_1S_AGO=$(date -u -d '48 hours ago 1 second ago' '+%Y-%m-%dT%H:%M:%S.%3NZ' 2>/dev/null || date -u -v-48H -v+1S '+%Y-%m-%dT%H:%M:%S.%3NZ')
          FORTY_EIGHT_HOURS_2S_AGO=$(date -u -d '48 hours ago 2 seconds ago' '+%Y-%m-%dT%H:%M:%S.%3NZ' 2>/dev/null || date -u -v-48H -v+2S '+%Y-%m-%dT%H:%M:%S.%3NZ')
          FORTY_EIGHT_HOURS_3S_AGO=$(date -u -d '48 hours ago 3 seconds ago' '+%Y-%m-%dT%H:%M:%S.%3NZ' 2>/dev/null || date -u -v-48H -v+3S '+%Y-%m-%dT%H:%M:%S.%3NZ')

          # Service startup
          echo "$FORTY_EIGHT_HOURS_AGO INFO: Starting auth-service v1.4.0"
          echo "$FORTY_EIGHT_HOURS_AGO INFO: Loading configuration from environment variables"
          echo "$FORTY_EIGHT_HOURS_AGO INFO: Validating configuration..."

          # Configuration errors
          echo "$FORTY_EIGHT_HOURS_1S_AGO ERROR: Missing required environment variable: JWT_SECRET"
          echo "$FORTY_EIGHT_HOURS_1S_AGO ERROR: JWT_SECRET is required for token signing and verification"
          echo "$FORTY_EIGHT_HOURS_1S_AGO WARN: Using default value for SESSION_TIMEOUT: 3600"

          # More config issues
          echo "$FORTY_EIGHT_HOURS_2S_AGO ERROR: Invalid Redis connection string format"
          echo "$FORTY_EIGHT_HOURS_2S_AGO ERROR: Expected format: redis://[user:password@]host:port/db"
          echo "$FORTY_EIGHT_HOURS_2S_AGO ERROR: Received: redis://invalid-format"
          echo "$FORTY_EIGHT_HOURS_2S_AGO ERROR: java.net.URISyntaxException: Malformed Redis URL"

          # Configuration validation failure
          echo "$FORTY_EIGHT_HOURS_3S_AGO ERROR: Configuration validation failed:"
          echo "$FORTY_EIGHT_HOURS_3S_AGO ERROR:   - Missing required environment variables: JWT_SECRET"
          echo "$FORTY_EIGHT_HOURS_3S_AGO ERROR:   - Invalid Redis connection string"
          echo "$FORTY_EIGHT_HOURS_3S_AGO ERROR:   - OAuth callback URL not specified"
          echo "$FORTY_EIGHT_HOURS_3S_AGO FATAL: Cannot start service with invalid configuration"
          echo "$FORTY_EIGHT_HOURS_3S_AGO INFO: Please check your deployment configuration and environment variables"
          echo "$FORTY_EIGHT_HOURS_3S_AGO INFO: Shutting down..."

          # Exit with error
          exit 1
        env:
        - name: REDIS_URL
          value: "redis://invalid-format"
        - name: SERVICE_PORT
          value: "8080"
        # JWT_SECRET is intentionally missing
