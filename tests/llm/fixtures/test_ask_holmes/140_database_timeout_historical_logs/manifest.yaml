apiVersion: v1
kind: Secret
metadata:
  name: order-service-app
  namespace: app-140-historical
type: Opaque
stringData:
  app.sh: |
    #!/bin/sh
    # Generate timestamps for 48 hours ago
    FORTY_EIGHT_HOURS_AGO=$(date -u -d '48 hours ago' '+%Y-%m-%dT%H:%M:%S.%3NZ' 2>/dev/null || date -u -v-48H '+%Y-%m-%dT%H:%M:%S.%3NZ')
    FORTY_EIGHT_HOURS_30M_AGO=$(date -u -d '48 hours ago 30 minutes ago' '+%Y-%m-%dT%H:%M:%S.%3NZ' 2>/dev/null || date -u -v-48H -v+30M '+%Y-%m-%dT%H:%M:%S.%3NZ')
    FORTY_EIGHT_HOURS_45M_AGO=$(date -u -d '48 hours ago 45 minutes ago' '+%Y-%m-%dT%H:%M:%S.%3NZ' 2>/dev/null || date -u -v-48H -v+45M '+%Y-%m-%dT%H:%M:%S.%3NZ')
    FORTY_SEVEN_HOURS_AGO=$(date -u -d '47 hours ago' '+%Y-%m-%dT%H:%M:%S.%3NZ' 2>/dev/null || date -u -v-47H '+%Y-%m-%dT%H:%M:%S.%3NZ')

    # Normal startup
    echo "$FORTY_EIGHT_HOURS_AGO INFO: Order service v2.3.1 starting..."
    echo "$FORTY_EIGHT_HOURS_AGO INFO: Loading configuration from environment"
    echo "$FORTY_EIGHT_HOURS_AGO INFO: Initializing database connection pool"

    # First connection attempts fail
    echo "$FORTY_EIGHT_HOURS_AGO ERROR: Failed to connect to database postgres-primary:5432"
    echo "$FORTY_EIGHT_HOURS_AGO ERROR: org.postgresql.util.PSQLException: Connection to postgres-primary:5432 refused"
    echo "$FORTY_EIGHT_HOURS_AGO INFO: Retrying database connection (attempt 1/5)..."

    # Multiple retry attempts with timeouts
    echo "$FORTY_EIGHT_HOURS_30M_AGO ERROR: Connection attempt timed out after 30000ms"
    echo "$FORTY_EIGHT_HOURS_30M_AGO ERROR: java.net.SocketTimeoutException: connect timed out"
    echo "$FORTY_EIGHT_HOURS_30M_AGO INFO: Retrying database connection (attempt 2/5)..."

    echo "$FORTY_EIGHT_HOURS_45M_AGO ERROR: Connection attempt timed out after 30000ms"
    echo "$FORTY_EIGHT_HOURS_45M_AGO ERROR: Caused by: java.net.ConnectException: Connection timed out"
    echo "$FORTY_EIGHT_HOURS_45M_AGO WARN: Database connection pool initialization failed"
    echo "$FORTY_EIGHT_HOURS_45M_AGO INFO: Retrying database connection (attempt 3/5)..."

    # More failures
    echo "$FORTY_SEVEN_HOURS_AGO ERROR: Connection to postgres-primary:5432 timed out"
    echo "$FORTY_SEVEN_HOURS_AGO ERROR: Could not create connection to database server"
    echo "$FORTY_SEVEN_HOURS_AGO INFO: Retrying database connection (attempt 4/5)..."
    echo "$FORTY_SEVEN_HOURS_AGO ERROR: Connection attempt timed out after 30000ms"
    echo "$FORTY_SEVEN_HOURS_AGO INFO: Retrying database connection (attempt 5/5)..."
    echo "$FORTY_SEVEN_HOURS_AGO ERROR: Final connection attempt failed"
    echo "$FORTY_SEVEN_HOURS_AGO FATAL: Unable to establish database connection after 5 attempts"
    echo "$FORTY_SEVEN_HOURS_AGO FATAL: Application cannot start without database connection"
    echo "$FORTY_SEVEN_HOURS_AGO INFO: Shutting down order service"

    # Exit with error
    exit 1

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: order-service
  namespace: app-140-historical
spec:
  replicas: 1
  selector:
    matchLabels:
      app: order-service
  template:
    metadata:
      labels:
        app: order-service
    spec:
      containers:
      - name: order-service
        image: busybox
        command: ["sh", "/app/app.sh"]
        volumeMounts:
        - name: app-code
          mountPath: /app
      volumes:
      - name: app-code
        secret:
          secretName: order-service-app
          defaultMode: 0755
